<!DOCTYPE html>
<html>
  <head>
    <title>NFC Attendance System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png" sizes="32x32">
  </head>
  <body>
    <div class="container">
      <h1>NFC 出退勤システム</h1>
      <div id="current-time"></div>
      <p>現在のモード:</p>
      <div id="mode-display-container">
        <span id="mode-text">出勤</span>
        <label class="switch">
          <input type="checkbox" id="mode-toggle">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="log-container">
        <h2>出退勤履歴</h2>
        <ul id="log-list" class="log-list">
          <li>ログはありません</li>
        </ul>
      </div>
    </div>
    <script>
      let currentMode = '出勤';

      // 現在時刻を更新する関数
      function updateTimeDisplay() {
        const now = new Date();
        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const formattedTime = now.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') + ' ' + now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('current-time').innerText = formattedTime;
      }

      // UIのモード表示を更新する関数
      function updateModeDisplay(mode) {
        const modeText = document.getElementById('mode-text');
        const modeToggle = document.getElementById('mode-toggle');
        
        modeText.innerText = mode;
        if (mode === '出勤') {
          modeText.style.color = '#28a745';
          modeToggle.checked = true;
        } else {
          modeText.style.color = '#dc3545';
          modeToggle.checked = false;
        }
        currentMode = mode;
      }

      // サーバーにモード切り替えを要求する関数
      async function setMode(mode) {
        try {
          const response = await fetch('/api/mode', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ mode: mode })
          });
          const data = await response.json();
          if (data.success) {
            updateModeDisplay(data.newMode);
            fetchAndRenderLogs();
          }
        } catch (error) {
          console.error('Failed to set mode:', error);
        }
      }

      // ログを取得してUIを更新する関数
      async function fetchAndRenderLogs() {
        try {
          const response = await fetch('/api/status');
          const data = await response.json();
          const logList = document.getElementById('log-list');
          logList.innerHTML = '';
          if (data.logs.length > 0) {
            // ヘッダーを追加
            const header = document.createElement('li');
            header.className = 'log-item-header';
            header.innerHTML = `
              <span>タイムスタンプ</span>
              <span>社員番号</span>
              <span>名前</span>
              <span>モード</span>
              <span>GAS同期</span>
              <span>IDm</span>
            `;
            logList.appendChild(header);

            data.logs.reverse().forEach(log => {
              const li = document.createElement('li');
              li.className = 'log-item';
              const syncStatus = log.isSyncedWithGas ? '✓' : '✗';
              const syncColor = log.isSyncedWithGas ? '#28a745' : '#dc3545';
              
              li.innerHTML = `
                <div><span class="log-item-timestamp">${log.timestamp}</span></div>
                <div><span class="log-item-employeeId">${log.employeeId}</span></div>
                <div><span class="log-item-name">${log.name}</span></div>
                <div><span class="log-item-mode" style="color: ${log.mode === '出勤' ? '#28a745' : '#dc3545'};">${log.mode}</span></div>
                <div><span class="log-item-sync" style="color: ${syncColor};">${syncStatus}</span></div>
                <div><span class="log-item-idm">${log.idm}</span></div>
              `;
              logList.appendChild(li);
            });
          } else {
            logList.innerHTML = '<li>ログはありません</li>';
          }
          updateModeDisplay(data.mode);
        } catch (error) {
          console.error('Failed to fetch logs:', error);
        }
      }

      // ページロード時に実行
      window.onload = function() {
        updateTimeDisplay();
        setInterval(updateTimeDisplay, 1000);
        fetchAndRenderLogs();
        setInterval(fetchAndRenderLogs, 5000);
        
        const modeToggle = document.getElementById('mode-toggle');
        modeToggle.addEventListener('change', (event) => {
          if (event.target.checked) {
            setMode('出勤');
          } else {
            setMode('退勤');
          }
        });
      };
    </script>
  </body>
</html>
